#!/usr/bin/env node

// Generated by CoffeeScript 1.3.3
var Docker, args, argv, booleanish, color, configFilenames, configToUse, d, field, fields, filename, fs, i, localJSConfig, newArgv, opts, path, pwd, watchr, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9;

path = require("path");

watchr = require("watchr");

fs = require("fs");

Docker = require("docker").Docker;

try {
  require("colors");
} catch (e) {
  _ref = ["red", "green", "grey", "magenta", "bold", "underline", "blue", "cyan", "yellow"];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    color = _ref[_i];
    String.prototype.__defineGetter__(color, function() {
      return this.toString();
    });
  }
}

pwd = path.resolve(".");

configToUse = null;

argv = require("optimist").argv;

if ((argv != null ? argv._[0] : void 0) === "use" && ((argv != null ? argv._[1] : void 0) != null) && argv._[1].toString().trim().length > 0) {
  configToUse = argv._[1].toString().trim();
}

configFilenames = [];

if (configToUse != null) {
  configFilenames.push(path.join(pwd, "docker.config." + configToUse + ".js"));
}

configFilenames.push(path.join(pwd, "docker.config.js"));

configFilenames.push(path.join(process.env.HOME, ".docker"));

localJSConfig = {};

for (_j = 0, _len1 = configFilenames.length; _j < _len1; _j++) {
  filename = configFilenames[_j];
  try {
    localJSConfig = require(filename);
    console.log("Using config file '" + filename + "'.");
    break;
  } catch (err) {
    continue;
  }
}

console.log(localJSConfig);

argv = require("optimist").alias("i", "inDir").describe("i", "Input directory (defaults to current dir)")["default"]("i", (_ref8 = localJSConfig.inDir) != null ? _ref8 : pwd).alias("o", "outDir").describe("o", "Output directory (defaults to ./doc)")["default"]("o", (_ref7 = localJSConfig.outDir) != null ? _ref7 : path.join(pwd, "doc")).alias("t", "tplDir").describe("t", "Directory containing dox.<ext>, code.<ext>, and tmpl.<ext>")["default"]("t", (_ref6 = localJSConfig.tplDir) != null ? _ref6 : path.join(__dirname, "..", "res")).alias("e", "tplEngine").describe("e", "Template parser (see github.com/visionmedia/consolidate.js)")["default"]("e", (_ref5 = localJSConfig.tplEngine) != null ? _ref5 : "internal").alias("n", "tplExtension").describe("n", "Template file extension ")["default"]("n", (_ref4 = localJSConfig.tplExtension) != null ? _ref4 : "jst").alias("m", "markdownEngine").describe("m", "Only two choices, cowboy.")["default"]("m", (_ref3 = localJSConfig.markdownEngine) != null ? _ref3 : "marked").alias("u", "onlyUpdated").describe("u", "Only process files that have been changed")["default"]("u", localJSConfig.onlyUpdated).alias("c", "colourScheme").describe("c", "Colour scheme to use (as in pygmentize -L styles)")["default"]("c", localJSConfig.colourScheme).alias("w", "watch").describe("w", "Watch on the input directory for file changes (experimental)")["default"]("w", localJSConfig.watch).alias("I", "ignoreHidden").describe("I", "Ignore hidden files and directories (starting with . or _)")["default"]("I", localJSConfig.ignoreHidden).alias("s", "sidebarState").describe("s", "Whether the sidebar should be open or not by default")["default"]("s", (_ref2 = localJSConfig.sidebarState) != null ? _ref2 : "yes").alias("x", "exclude").describe("x", "Paths to exclude")["default"]("x", (_ref1 = localJSConfig.exclude) != null ? _ref1 : false).argv;

booleanish = function(input) {
  if (input === true || input === false) {
    return input;
  }
  if (typeof input === "number" || (+input + "" === input + "")) {
    return !!+input;
  }
  input = input.toString();
  if (input === "") {
    return true;
  } else {
    return /(y(es)?|ok|t(rue)?)/i.test(input);
  }
};

fields = ["inDir", "outDir", "tplDir", "tplEngine", "tplExtension", "markdownEngine", "onlyUpdated", "colourScheme", "ignoreHidden", "sidebarState", "exclude"];

console.log("Options:".white.bold);

opts = {};

for (_k = 0, _len2 = fields.length; _k < _len2; _k++) {
  field = fields[_k];
  opts[field] = argv[field];
  console.log(field.red + ": ".white + ((_ref9 = opts[field]) != null ? _ref9 : "-").grey);
}

d = new Docker(opts);

args = argv._;

if (args.length > 0) {
  newArgv = [];
  i = 0;
  while (i < args.length) {
    if (args[i] === "use") {
      i += 2;
    } else {
      newArgv.push(args[i]);
      i++;
    }
  }
  args = newArgv;
}

if (args.length <= 0) {
  args = ["./"];
}

if (argv.watch) {
  d.watch(args);
} else {
  d.doc(args);
}
